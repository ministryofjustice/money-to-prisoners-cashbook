{% extends 'cashbook/credits_base.html' %}
{% load i18n %}
{% load currency %}
{% load mtp_common %}
{% load credits %}
{% load staticfiles %}

{% block page_title %}{% trans 'New credits - Digital cashbook' %}{% endblock %}

{% block body_classes %}{{ block.super }} mtp-credits{% endblock %}

{% block page_content %}

  <header>
    {% language_switch %}
    <h1 class="heading-xlarge">{{ view.title }}</h1>
  </header>

  {% if credited_credits %}
  <div class="mtp-crediting-result mtp-credited-credits print-hidden">
      {% blocktrans count credited_credits=credited_credits %}
      {{ credited_credits }} credit sent to NOMIS
      {% plural %}
      {{ credited_credits }} credits sent to NOMIS
      {% endblocktrans %}
      <a href="{% url 'all-credits' %}" class="mtp-end-link">{% trans "View" %}</a>
  </div>
  {% endif %}

  {% if failed_credits %}
  <div class="mtp-crediting-result mtp-failed-credits print-hidden">
      {% blocktrans count failed_credits=failed_credits %}
      {{ failed_credits }} credit couldn’t be processed
      {% plural %}
      {{ failed_credits }} credits couldn’t be processed
      {% endblocktrans %}
      <a href="#failed-credits-dialog" class="js-Dialog mtp-end-link">{% trans "Why?" %}</a>
  </div>

  <div id="failed-credits-dialog"
       class="Dialog"
       style="display: none"
       data-hide-close="true"
       data-disable-backdrop-close="true">
    <div class="Dialog-inner">
      <h2 class="heading-large">{% trans 'Why didn’t it work?' %}</h2>
      <p>
        {% trans 'Sometimes a fault in the system prevents credits from being processed.' %}
        {% trans 'Please wait a few minutes and try sending to NOMIS again.' %}
      </p>
      <button type="button" class="button js-Dialog-close">{% trans 'Ok' %}</button>
    </div>
  </div>
  {% endif %}

  {% if manual_credits %}
  <div class="mtp-crediting-result mtp-manual-credits print-hidden">
      {% blocktrans count manual_credits=manual_credits %}
      {{ manual_credits }} credit needs your manual input in NOMIS - see below
      {% plural %}
      {{ manual_credits }} credits need your manual input in NOMIS - see below
      {% endblocktrans %}
  </div>
  {% endif %}

  <div class="print-only">
    <h2 class="heading-small">
      {% trans "CONFIDENTIAL: dispose of securely" %}
    </h2>
  </div>

  {% if manual_object_list %}
  <div class="print-hidden"><p>{% trans ' These credits need your manual input to be processed.' %}</p></div>

  <form class="js-ConfirmManual" method="post" action="" data-credits-name="{{ form.manual.credits.html_name }}">
    {% csrf_token %}
    {% include 'mtp_common/forms/error-summary.html' with form=form.manual only %}
    <div class="mtp-batch mtp-manual-credits-batch">
      <table>
        <thead>
          <tr class="print-hidden">
            <td colspan="{% if pre_approval_required%}6{% else %}5{% endif %}" class="cell--compact">
              <a href="#" class="js-Print" data-do-not-print=".mtp-new-credits-batch">{% trans "Print these credits" %}</a>
            </td>
          </tr>
          <tr>
            <th>{% trans 'Date sent' %}</th>
            <th>{% trans 'Prisoner' %}</th>
            <th>{% trans 'Amount' %}</th>
            <th>{% trans 'Sender' %}</th>
            {% if pre_approval_required %}
              <th>{% trans 'Security' %}</th>
            {% endif %}
            <th class="print-hidden"></th>
          </tr>
        </thead>

        <tbody>
          {% for credit_pk, credit in manual_object_list %}
            {% if completed_index == 0 and forloop.counter0 == 0 %}
              <tr class="mtp-manual-credit-complete">
                <td colspan="1"></td>
                <td colspan="{% if pre_approval_required%}5{% else %}4{% endif %}">
                  {% trans 'You have manually put this into NOMIS' %}
                </td>
              </tr>
            {% endif %}
            <tr>
              <td>
                <div>{{ credit.received_at.date|date:'d/m/Y' }}</div>
                {% with days=credit.received_at.date|dayssince %}
                <div class="sub {% if days >= 7 %}old{% endif %}">
                  {% if days == 0 %}
                    {% trans 'Today' %}
                  {% else %}
                    {% blocktrans count days=days %}
                    {{ days }} day ago
                    {% plural %}
                    {{ days }} days ago
                    {% endblocktrans %}
                  {% endif %}
                </div>
                {% endwith %}
              </td>
              <td>
                <div>{{ credit.prisoner_number }}</div>
                <div class="sub">{{ credit.prisoner_name }}</div>
              </td>
              <td class="number">&pound;{{ credit.amount|currency }}</td>
              <td>{{ credit.sender_name }}</td>
              {% if pre_approval_required %}
                <td>
                  {% if credit.reviewed %}
                    {% trans 'Checked' %}
                  {% else %}
                    {% trans 'Not checked' %}
                  {% endif %}
                </td>
              {% endif %}
              <td></td>
            </tr>
            {% if credit.comments %}
              <tr>
                <td class="mtp-security" colspan="{% if pre_approval_required%}6{% else %}5{% endif %}">
                  {% for comment in credit.comments %}
                    <div class="mtp-security__comment">
                      {{ comment.comment|linebreaks }}
                    </div>
                  {% endfor %}
                </td>
              </tr>
            {% endif %}
            <tr>
              <td class="mtp-manual-action"></td>
              <td class="mtp-manual-action" colspan="{% if pre_approval_required %}4{% else %}3{% endif %}">
                <div class="mtp-manual-action__details">
                  {% trans 'You need to manually put this into NOMIS:' %}
                  {% if credit.new_location.nomis_id == 'TRN' %}
                    {% trans 'Prisoner in transit' %}
                  {% elif credit.new_location.nomis_id %}
                    {% blocktrans with new_prison=credit.new_location.name %}
                    Prisoner transferred to {{ new_prison }}
                    {% endblocktrans %}
                  {% else %}
                    {% trans 'Prisoner left this prison' %}
                  {% endif %}
                </div>
              </td>
              <td class="mtp-manual-action print-hidden" style="text-align: center;">
                <button type="submit" name="submit_manual_{{ credit_pk }}" value="submit"  class="button" data-credit-id="{{ credit_pk }}">{% trans 'Done' %}</button>
              </td>
              <div id="manual-confirm-dialog-{{credit_pk}}"
                   class="Dialog"
                   style="display: none"
                   data-hide-close="true"
                   data-disable-backdrop-close="true">
                <div class="Dialog-inner">
                  <h2 class="heading-large">{% trans 'Have you updated NOMIS?' %}</h2>
                  <button type="submit"
                          name="submit_manual_{{credit_pk}}"
                          class="button"
                          value="override">{% trans 'Yes' %}</button>
                  <br/><br/>
                  <a href="#" class="js-Dialog-close">{% trans 'No, I’ll do that now' %}</a>
                </div>
              </div>
            </tr>
            {% if completed_index == forloop.counter %}
              <tr class="mtp-manual-credit-complete">
                <td colspan="1"></td>
                <td colspan="{% if pre_approval_required%}5{% else %}4{% endif %}">
                  {% trans 'You have manually put this into NOMIS' %}
                </td>
              </tr>
            {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </form>
  {% endif %}

  <form
    method="post"
    action=""
    class="js-BeforeUnload js-BatchValidation"
    data-credits-name="{{ form.new.credits.html_name }}">
    {% csrf_token %}

    {% include 'mtp_common/forms/error-summary.html' with form=form.new only %}

    <div class="mtp-batch mtp-new-credits-batch {% if not new_object_list %}print-hidden{% endif %}">
      {% if new_object_list %}
        <div class="mtp-floating-header js-StickyHeader print-hidden">
          <div class="grid-row">
            <div class="column-two-thirds">
              <p class="print-hidden">
                {% if new_credits == 1 %}
                  {% trans '<strong>{{ new_credits }}</strong> new credit.' %}
                {% else %}
                  {% blocktrans trimmed %}
                  <strong>{{ new_credits }}</strong> new credits.
                  {% endblocktrans %}
                {% endif %}
                <span class="mtp-none-selected">{% trans "You haven’t selected any to process yet." %}</span>
                <span class="mtp-some-selected">
                  {% blocktrans trimmed %}
                  <strong><span class="js-SelectionCount"></span></strong> credits selected for processing in NOMIS.
                  {% endblocktrans %}
                </span>
              </p>
            </div>

            <div class="column-one-third mtp-submit__button">
              {% if new_object_list %}
                <button type="submit" name="submit_new" value="submit" class="button">{% trans 'Credit to NOMIS' %}</button>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="mtp-nomis-print-header print-only">
          <img src="{% static 'images/icon-important.png' %}"/>
          <div class="mtp-nomis-warning">
            <h2 class="heading-medium">
              {% trans 'You don’t have to manually enter credits into NOMIS any more' %}
            </h2>
            <div>
              {% trans 'Now when you ’confirm’ credits, they’ll be sent digitally to NOMIS' %}
            </div>
          </div>
        </div>
      {% else %}
        <p>{% trans "No new credits received" %}</p>
      {% endif %}


      <table>
        <thead>
          {% if new_object_list %}
            {% include 'cashbook/includes/table_actions.html' with location='header' field_name=form.new.credits.html_name batch_size=batch_size print=False %}
          {% endif %}

          <tr>
            <th class="{{ request|ordering_classes:'received_at' }}">
              <a href="?{{ request|query_string_with_reversed_ordering:'received_at' }}">
                <span>
                  {% trans 'Date sent' %}
                  {% describe_ordering_for_screenreader request 'received_at' %}
                </span>
              </a>
            </th>
            <th class="{{ request|ordering_classes:'prisoner_number' }}">
              <a href="?{{ request|query_string_with_reversed_ordering:'prisoner_number' }}">
                <span>
                  {% trans 'Prisoner' %}
                  {% describe_ordering_for_screenreader request 'prisoner_number' %}
                </span>
              </a>
            </th>
            <th class="{{ request|ordering_classes:'amount' }} number">
              <a href="?{{ request|query_string_with_reversed_ordering:'amount' }}">
                <span>
                  {% trans 'Amount' %}
                  {% describe_ordering_for_screenreader request 'amount' %}
                </span>
              </a>
            </th>
            <th>{% trans 'Sender' %}</th>
            {% if pre_approval_required %}
              <th>{% trans 'Security' %}</th>
            {% endif %}
            <th class="check print-hidden"><span id="id_credits-label">{% trans 'Select' %}</span></th>
          </tr>
        </thead>

        {% if new_object_list %}
          <tbody>
            {% for credit_pk, credit in new_object_list %}
              <tr>
                <td>
                  <div>{{ credit.received_at.date|date:'d/m/Y' }}</div>
                  {% with days=credit.received_at.date|dayssince %}
                  <div class="sub {% if days >= 7 %}old{% endif %}">
                    {% if days == 0 %}
                      {% trans 'Today' %}
                    {% else %}
                      {% blocktrans count days=days %}
                      {{ days }} day ago
                      {% plural %}
                      {{ days }} days ago
                      {% endblocktrans %}
                    {% endif %}
                  </div>
                  {% endwith %}
                </td>
                <td>
                  <div>{{ credit.prisoner_number }}</div>
                  <div class="sub">{{ credit.prisoner_name }}</div>
                </td>
                <td class="number">&pound;{{ credit.amount|currency }}</td>
                <td>{{ credit.sender_name }}</td>
                {% if pre_approval_required %}
                  <td>
                    {% if credit.reviewed %}
                      {% trans 'Checked' %}
                    {% else %}
                      {% trans 'Not checked' %}
                    {% endif %}
                  </td>
                {% endif %}
                <td class="check print-hidden">
                  <input
                    type="checkbox"
                    name="{{ form.new.credits.html_name }}"
                    value="{{ credit_pk }}"
                    id="check-{{ credit.id }}"
                    {% if credit_pk|to_string in form.new.credits.value %}checked{% endif %}
                    class="js-SelectionCount-item Checkbox"
                    data-amount="{{ credit.amount|currency }}">
                  <label for="check-{{ credit.id }}">{% trans 'Credited' %}</label>
                </td>
              </tr>
              {% if credit.comments %}
                <tr>
                  <td class="mtp-security" colspan="{% if pre_approval_required%}6{% else %}5{% endif %}">
                    {% for comment in credit.comments %}
                      <div class="mtp-security__comment">
                        {{ comment.comment|linebreaks }}
                      </div>
                    {% endfor %}
                  </td>
                </tr>
              {% endif %}
            {% endfor %}
          </tbody>

          <tfoot>
            {% include 'cashbook/includes/table_actions.html' with location='footer' field_name=form.new.credits.html_name batch_size=batch_size print=False %}
          </tfoot>
        {% else %}
          <tbody>
            <tr>
              <td class="mtp-no-credits" colspan="{% if pre_approval_required%}6{% else %}5{% endif %}">
                <h2 class="heading-large">{% trans 'Thank you' %}</h2>
                <p>{% trans 'All credits have been processed' %}</p>
              </td>
            </tr>
          </tbody>
        {% endif %}
      </table>

    </div>

    <div id="incomplete-batch-dialog"
         class="Dialog"
         style="display: none"
         data-hide-close="true"
         data-disable-backdrop-close="true">
      <div class="Dialog-inner">
        <h2 class="heading-large">{% trans 'Do you want to submit only the selected credits?' %}</h2>
        <button type="submit"
                name="submit_new"
                class="button"
                value="override">{% trans 'Yes' %}</button>
        <button type="button"
                class="button button-secondary js-Dialog-close"
                data-analytics="pageview,/batch/-dialog_close/">{% trans 'No, continue processing' %}</button>
      </div>
    </div>
  </form>

  {% include 'cashbook/includes/nomis_print_dialog.html' %}

{% endblock %}
