{% extends "base.html" %}
{% load i18n %}
{% load moj_utils %}
{% load currency transactions %}

{% block content %}
  <header class="ContentHeader">
    <a href="{% url 'dashboard' %}">{% trans 'home' %}</a>
    <h1>{% trans 'History of credits' %}</h1>
  </header>

  <form method="post" class="print-hidden" action="" style="width: 800px">
    {% csrf_token %}

    {% if form.errors %}
      <div class="error-summary" aria-labelledby="error-summary-heading" tabindex="-1" role="alert">
        <h1 class="error-summary-heading heading-medium" id="error-summary-heading">{% trans 'There was a problem submitting the form' %}</h1>
        <p>{% trans 'Because of the following problems:' %}</p>

        <ol class="error-summary-list">
          {% for field, errors in form.errors.items %}
            {% with field_obj=form|field_from_name:field %}
              <li>
                {% if field_obj %}
                  <a href="#{{ field_obj.auto_id }}-label">
                  {{ field_obj.label }} —
                {% endif %}
                {% for error in errors %}
                  {% if not forloop.first  %}
                    {% trans 'and' %}
                  {% endif %}
                  {{ error }}
                {% endfor %}
                {% if field_obj %}
                  </a>
                {% endif %}
              </li>
            {% endwith %}
          {% endfor %}
        </ol>
      </div>
    {% endif %}

    <div style="width: 60%">
      <div>
      <label>Date received</label>
      </div>
      <div id="form-group-received_at_0" class="form-group {% if form.received_at_0.errors %}error{% endif %}" style="float:left; width: 50%">
        <label for="id_received_at_0" id="id_received_at_0-label" class="form-label" style="margin: 0">
          <span style="font-weight: normal; margin-bottom: 0">Start</span>
          {% for error in form.received_at_0.errors %}
            <span class="error-message">{{ error }}</span>
          {% endfor %}
        </label>
        {{ form.received_at_0 }}
      </div>
      <div id="form-group-received_at_1" class="form-group {% if form.received_at_1.errors %}error{% endif %}" style="float:right; width: 50%">
        <label for="id_received_at_1" id="id_received_at_1-label" class="form-label" style="margin: 0">
          <span  style="font-weight: normal; margin-bottom: 0">Finish</span>
          {% for error in form.received_at_1.errors %}
            <span class="error-message">{{ error }}</span>
          {% endfor %}
        </label>
        {{ form.received_at_1 }}
      </div>
    </div>
    <div id="form-group-search" class="form-group {% if form.search.errors %}error{% endif %}" style="clear: both">
      <label for="id_search" id="id_search-label" class="form-label">
        Prisoner name, prisoner number or sender name
        {% for error in form.search.errors %}
          <span class="error-message">{{ error }}</span>
        {% endfor %}
      </label>
      {{ form.search }}
    </div>

    <div><input style="margin-top: 20px" class="button button-secondary" type="submit" value="{% trans 'Search' %}"></div>

    <hr style="margin: 35px 0 0 0"/>

    <div id="form-group-search" class="form-group {% if form.owner.errors %}error{% endif %}">
      <span style="font-weight: bold">View payments processed</span>
      {% for error in form.owner.errors %}
        <span class="error-message">{{ error }}</span>
      {% endfor %}
      <div onchange="$(this).closest('form').submit()">
      {{ form.owner }}
      </div>
    </div>

  </form>

  {% if object_list %}
    {% for transaction_date, group in object_list|parse_date_fields|regroup_transactions %}
      <h2 style="clear: both; padding-top: 20px">{{ transaction_date|date:'DATE_FORMAT' }}</h2>

      {% for transaction_status, transactions in group %}
        <div class="batch batch-history">

          <h3 class="HistoryHeader {% if transaction_status == 'uncredited' %}HistoryHeader-uncredited{% elif transaction_status == 'refunded' %}HistoryHeader-refunded{% endif %}">
            {% if transaction_status == 'uncredited' %}
              {% trans 'Uncredited' %}
            {% elif transaction_status == 'refunded' %}
              {% trans 'Refunded' %}
            {% else %}
              {% trans 'Credited' %}
            {% endif %}

            <span class="HistoryHeader-aside HistoryHeader-aside-right">{% trans 'Total' %}: £{{ transactions|sum_transactions|currency }}</span>

            <a class="u-nojs-hidden print-hidden HistoryHeader-aside ShowHide js-ShowHide" href="#HistoryBatch-{{ forloop.parentloop.counter }}-{{ forloop.counter }}">
              <span class="ShowHide-hide">
                {% trans 'Collapse' %}
                <span class="ShowHide-icon">&minus;</span>
              </span>
              <span class="ShowHide-show">
                {% trans 'Collapsed' %}
                <span class="ShowHide-icon">&plus;</span>
              </span>
            </a>
          </h3>

          <table id="HistoryBatch-{{ forloop.parentloop.counter }}-{{ forloop.counter }}">
            <thead>
              <tr>
                <th>{% trans 'Prisoner no' %}</th>
                <th>{% trans 'Prisoner name' %}</th>
                <th>{% trans 'Amount' %}</th>
                <th>{% trans 'Sender' %}</th>
<!--                <th>{% trans 'Payment type' %}</th>
                <th>{% trans 'Received at' %}</th>
                <th>{% trans 'Credited at' %}</th>
                <th>{% trans 'Refunded at' %}</th>
-->
                <th>{% trans 'Processed by' %}</th>
              </tr>
            </thead>

            <tbody>
            {% for transaction in transactions %}
              <tr {% if not forloop.counter|divisibleby:2 %}class="odd"{% endif %}>
                <td>{{ transaction.prisoner_number }}</td>
                <td>{{ transaction.prisoner_name }}</td>
                <td class="numeric">&pound;{{ transaction.amount|currency }}</td>
                <td>{{ transaction.sender }}</td>
                <!--
                <td>{% trans 'Bank transfer' %}</td>
                <td>{{ transaction.received_at|date:'m/d/Y H:i' }}</td>
                <td>
                  {% if transaction.credited %}
                    {{ transaction.credited_at|date:'m/d/Y H:i' }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td>
                  {% if transaction.refunded %}
                    {{ transaction.refunded_at|date:'m/d/Y H:i' }}
                  {% else %}
                    —
                  {% endif %}
                </td>
              -->
                <td>{{ transaction.owner_name|default_if_none:'—' }}</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>

      {% endfor %}
    {% endfor %}

    <p><a href="#print-dialog" class="js-Dialog print-hidden">{% trans 'Print these payments' %}</a></p>
    {% include 'cashbook/includes/print_dialog.html' %}

  {% else %}

    <table>
      <thead>
        <tr>
          <th>{% trans 'No payment history found for given filters' %}</th>
        </tr>
      </thead>
    </table>

  {% endif %}

{% endblock content %}
