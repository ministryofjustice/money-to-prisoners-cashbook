{% extends "base.html" %}
{% load i18n %}
{% load currency %}
{% load mtp_utils %}

{% block page_title %}{% trans "New credits - Digital cashbook" %}{% endblock %}

{% block template_type %}v-batch{% endblock %}

{% block content %}

  <header class="ContentHeader">
    <a id="header-home-link" href="{% url 'transaction-discard' %}" class="ContentHeader-back">{% trans 'Home' %}</a>
    <h1>{% trans 'New credits' %}</h1>
  </header>

  {% include "includes/message_box.html" %}

  <form
    method="post"
    action=""
    class="js-BeforeUnload js-BatchValidation"
    data-transactions-name="{{ form.transactions.html_name }}"
    data-unload-msg="{% trans "You are leaving this page, but have ticked credits. &#x0A;&#x0A; Click ‘Done’ if credits have been processed in NOMIS." %}">
    {% csrf_token %}


    {% if object_list %}
      {% if form.errors or form.non_field_errors %}
        <div class="error-summary" aria-labelledby="error-summary-heading" tabindex="-1" role="alert">
          <h1 class="error-summary-heading heading-medium" id="error-summary-heading">{% trans 'You have not ticked any credits' %}</h1>

          <ol class="error-summary-list">
            {% for field, errors in form.errors.items %}
              {% with field_obj=form|field_from_name:field %}
              <li><a href="#{{ field_obj.auto_id }}-label">
                {% for error in errors %}
                  {% if not forloop.first  %}
                    {% trans 'and' %}
                  {% endif %}
                  {{ error }}
                {% endfor %}
              </a></li>
              {% endwith %}
            {% endfor %}
          </ol>
        </div>
      {% endif %}

      <div class="help-box">
        <p>{% trans "These credits are ready to be processed in NOMIS. When you've finished crediting, click ‘Done’." %}</p>

        <div class="help-box-title" aria-controls="help-box-contents" aria-expanded="true">
          <div></div><a href="#">{%trans "Help" %}</a>
        </div>
        <div class="help-box-contents" id="help-box-contents">
          {% blocktrans %}
          <ul>
            <li>You can credit in NOMIS in the usual way but remember to select the <strong>‘Misc Receipt - Private Cash’ category as Transaction Type</strong></li>
            <li>You don’t need to use a reference</li>
            <li>In the Digital Cashbook below, tick off the credits you’ve entered in NOMIS and click ‘Done’ </li>
            <li>You might find it easier to copy and paste the prisoner number from the Digital Cashbook into NOMIS</li>
          </ul>
         {% endblocktrans %}
       </div>
      </div>

      <div class="batch">
        <div class="print-box">
          <p>
            {% trans "CONFIDENTIAL: dispose of securely" %}
          </p>
          <p>
            {% trans "When you’ve processed these credits in NOMIS, select them in the digital cashbook and click ‘Done’." %}
          </p>
        </div>

        <div class="totals js-StickyHeader">
          <div class="container js-RunningTotal" data-label="{% trans 'Credits processed in NOMIS' %}">
            <p>
              <span class='label'>{% trans 'Control total' %}</span><span class='total'>&pound;{{total|currency}}</span>
            </p>
          </div>
        </div>

        {% include "cashbook/includes/batch_buttons.html" %}



        <table>
          <thead>
            {% include "cashbook/includes/table_actions.html" with location='header' field_name=form.transactions.html_name %}

            <tr>
              <th>{% trans "Prisoner no" %}</th>
              <th>{% trans "Prisoner name" %}</th>
              <th>{% trans "Amount&nbsp;(&pound;)" %}</th>
              <th>{% trans "Sender" %}</th>
              <th class="check"><span id="id_transactions-label">{% trans "Credited?" %}</span></th>
            </tr>
          </thead>

          <tbody>
          {% for transaction_pk, transaction in object_list %}
            <tr {% if forloop.counter|divisibleby:2 %}{% else %}class="odd"{% endif %}>
              <td>{{ transaction.prisoner_number }}</td>
              <td>{{ transaction.prisoner_name }}</td>
              <td class="numeric">{{ transaction.amount|currency }}</td>
              <td>{{ transaction.sender }}</td>
              <td class="check">
                <input
                  type="checkbox"
                  name="{{ form.transactions.html_name }}"
                  value="{{ transaction_pk }}"
                  id="check-{{ transaction.id }}"
                  {% if transaction_pk|to_string in form.transactions.value %}checked{% endif %}
                  class="js-RunningTotal-item"
                  data-amount="{{ transaction.amount|currency }}">
                <label for="check-{{ transaction.id }}">{% trans "Credited" %}</label>
              </td>
            </tr>
          {% endfor %}
          </tbody>

          <tfoot>
            {% include "cashbook/includes/table_actions.html" with location='footer' field_name=form.transactions.html_name %}
          </tfoot>
        </table>

        {% include "cashbook/includes/batch_buttons.html" %}

      </div>
    {% else %}
      <p>{% trans "No transactions found" %}</p>
    {% endif %}

    <dialog id="incomplete-batch-dialog"
            class="Dialog u-nojs-hidden"
            data-hide-close="true"
            data-disable-backdrop-close="true">
      <div class="Dialog-inner">
        <h3>{% trans "Are you sure?" %}</h3>
        <p>{% trans "Do you want to submit only the selected credits?" %}</p>
        <button type="submit"
                class="button"
                value="override">{% trans "Yes" %}</button>
        <button type="button"
                class="button button-secondary js-Dialog-close"
                data-analytics="pageview,/batch/-dialog_close/">{% trans "No, continue processing" %}</button>
      </div>
    </dialog>
  </form>

  {% include "cashbook/includes/print_dialog.html" %}

{% endblock content %}
